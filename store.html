 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAT Chennai - Stock Management v5</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <style>
        /* --- General Body & Font --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f7f6;
            color: #333;
            margin: 0;
            padding: 20px;
        }

        /* --- Main Container --- */
        #main-container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        /* --- Header --- */
        header {
            background-color: #004a99;
            color: white;
            padding: 20px 30px;
        }
        header h1 {
            margin: 0;
            font-size: 1.8em;
            text-align: center;
        }
        header p {
            margin: 5px 0 15px;
            font-size: 1.1em;
            text-align: center;
            opacity: 0.9;
        }
        .header-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        #search-bar {
            flex-grow: 1;
            padding: 10px;
            font-size: 1em;
            border-radius: 4px;
            border: 1px solid #ccc;
            min-width: 250px;
        }
        .header-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .header-buttons button {
            padding: 10px 15px;
            font-size: 0.9em;
            font-weight: 600;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: white;
        }
        
        #dashboard-btn { background-color: #fd7e14; }
        #dashboard-btn:hover { background-color: #e66a00; }
        #batch-update-btn { background-color: #6610f2; }
        #batch-update-btn:hover { background-color: #560bd0; }
        #report-btn { background-color: #ffc107; color: #333; }
        #report-btn:hover { background-color: #e0a800; }
        #log-btn { background-color: #6f42c1; }
        #log-btn:hover { background-color: #5a379e; }
        #print-btn { background-color: #17a2b8; }
        #print-btn:hover { background-color: #138496; }

        .data-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            padding-top: 15px;
        }
        .data-buttons button {
            padding: 8px 12px;
            font-size: 0.9em;
            font-weight: 600;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        #export-btn { background-color: #28a745; color: white; border: none; }
        #export-btn:hover { background-color: #218838; }
        #import-btn { background-color: #dc3545; color: white; border: none; }
        #import-btn:hover { background-color: #c82333; }
        #import-file-input { display: none; }


        /* --- Category (Accordion) --- */
        #category-container {
            border-bottom: 1px solid #ddd;
        }
        .category-header {
            display: flex;
            width: 100%;
            border: none;
            background-color: #e9ecef;
            border-bottom: 1px solid #ddd;
            transition: background-color 0.3s ease;
        }
        .category-header:hover { background-color: #d8dee2; }
        
        .accordion {
            background: none;
            border: none;
            color: #495057;
            cursor: pointer;
            padding: 18px 30px;
            flex-grow: 1;
            text-align: left;
            outline: none;
            font-size: 1.2em;
            font-weight: 600;
        }
        .accordion:after {
            content: '\002B'; /* Plus */
            color: #004a99;
            font-weight: bold;
            float: right;
            margin-left: 5px;
        }
        .accordion.active:after { content: "\2212"; /* Minus */ }
        
        .category-header-controls {
            padding: 0 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            background-color: #e9ecef;
        }
        .category-header-controls button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            opacity: 0.6;
        }
        .category-header-controls button:hover { opacity: 1; color: #004a99; }
        
        .panel {
            padding: 0;
            background-color: white;
            display: none;
            overflow: hidden;
        }

        /* --- Stock Table --- */
        .stock-table { width: 100%; border-collapse: collapse; }
        .stock-table th, .stock-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eef;
        }
        .stock-table th { background-color: #f8f9fa; font-weight: 600; }
        .stock-table tr:last-child td { border-bottom: none; }
        .stock-table tr:hover { background-color: #f1f3f5; }
        
        .sortable-header { cursor: pointer; user-select: none; }
        .sortable-header:hover { background-color: #e9ecef; }
        .sort-indicator {
            font-size: 0.8em; margin-left: 5px;
            display: inline-block; width: 10px; text-align: center;
        }

        /* --- Table Columns --- */
        .col-item { width: 35%; }
        .col-stock { width: 10%; text-align: center; }
        .col-min-stock { width: 10%; text-align: center; }
        .col-actions { width: 45%; text-align: center; }

        /* --- Interactive Elements --- */
        .stock-level {
            font-size: 1.2em;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 4px;
        }
        .low-stock { color: #d90429; background-color: #fff0f3; }
        .quantity-input {
            width: 50px; padding: 8px; margin-right: 8px;
            border: 1px solid #ccc; border-radius: 4px;
            text-align: center; font-size: 1em;
        }
        .btn {
            padding: 8px 10px; font-size: 0.9em; font-weight: 600;
            border: none; border-radius: 4px; cursor: pointer;
            transition: all 0.2s ease; margin: 0 2px; color: white;
        }
        
        /* Updated Button Styles */
        .btn-stock-in { background-color: #28a745; }
        .btn-stock-in:hover { background-color: #218838; }
        .btn-stock-out { background-color: #dc3545; }
        .btn-stock-out:hover { background-color: #c82333; }
        .btn-reset { background-color: #007bff; }
        .btn-reset:hover { background-color: #0069d9; }
        
        .btn-item-edit {
            background: none; border: none; cursor: pointer;
            font-size: 1.2em; opacity: 0.6; color: #007bff;
        }
        .btn-item-edit:hover { opacity: 1; }
        
        .btn-delete-item {
            background: none; border: none; color: #dc3545;
            cursor: pointer; font-size: 1.2em; font-weight: bold;
            margin-left: 10px; opacity: 0.5;
        }
        .btn-delete-item:hover { opacity: 1; }
        
        /* --- Add Item Form --- */
        .add-item-controls {
            padding: 15px; background-color: #f8f9fa;
            border-top: 1px solid #eef;
        }
        .add-item-form { display: none; gap: 10px; margin-top: 10px; }
        .new-item-name {
            flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px;
        }
        .btn-save-new { background-color: #007bff; }
        .btn-show-add-form {
            background-color: #f8f9fa; color: #007bff;
            border: 1px dashed #007bff; padding: 8px 12px;
            font-weight: 600; cursor: pointer; width: 100%;
        }
        .btn-show-add-form:hover { background-color: #e2e6ea; }

        /* --- Add Category Form --- */
        .add-category-controls {
            padding: 20px 30px;
            background-color: #e9ecef;
            border-top: 2px solid #004a99;
        }
        .add-category-form { display: flex; gap: 10px; }
        .new-category-name {
            flex-grow: 1; padding: 10px; border: 1px solid #ccc;
            border-radius: 4px; font-size: 1.1em;
        }
        .btn-save-new-category {
            padding: 10px 15px; font-size: 1.1em;
            font-weight: 600; border: none; border-radius: 4px;
            cursor: pointer; transition: all 0.2s ease;
            color: white; background-color: #004a99;
        }
        .btn-save-new-category:hover { background-color: #003366; }

        /* --- Modal --- */
        .modal {
            display: none; position: fixed; z-index: 1000;
            left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0, 0, 0, 0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 800px; /* Wider for dashboard/batch */
            border-radius: 8px;
        }
        .modal-header {
            display: flex; justify-content: space-between;
            align-items: center; border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }
        .modal-header h2 { margin: 0; }
        .close-btn {
            color: #aaa; float: right; font-size: 28px;
            font-weight: bold; cursor: pointer;
        }
        .close-btn:hover, .close-btn:focus { color: black; }
        
        .modal-list {
            list-style-type: none; padding: 0; margin-top: 20px;
            max-height: 50vh; overflow-y: auto; font-size: 0.95em;
        }
        .modal-list li { padding: 8px 0; border-bottom: 1px solid #eee; }
        
        #low-stock-list strong { color: #d90429; margin-right: 10px; }
        #low-stock-list .category-title {
            font-weight: bold; color: #004a99; background-color: #f4f7f6;
            padding: 10px; margin-top: 10px; border-radius: 4px;
        }
        
        #activity-log-list strong {
            color: #004a99; margin-right: 10px;
            display: inline-block; min-width: 160px;
        }
        
        /* --- Item Edit Modal Form --- */
        .form-grid {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 15px;
            align-items: center;
            margin-top: 20px;
        }
        .form-grid label { font-weight: 600; text-align: right; }
        .form-grid input, .form-grid select {
            width: 100%; padding: 8px; border: 1px solid #ccc;
            border-radius: 4px; box-sizing: border-box; /* Fixes width issue */
        }
        .modal-footer {
            text-align: right; margin-top: 20px;
            border-top: 1px solid #ddd; padding-top: 20px;
        }
        .btn-save-changes { background-color: #007bff; color: white; }
        
        /* --- Batch Update Modal --- */
        #batch-update-list {
            display: grid;
            grid-template-columns: 1fr 100px;
            gap: 10px;
            max-height: 60vh;
            overflow-y: auto;
            margin-top: 20px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        #batch-update-list label {
            font-weight: 500;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        #batch-update-list input {
            padding: 8px; border: 1px solid #ccc;
            border-radius: 4px; text-align: center;
        }
        
        /* --- Dashboard Modal --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .chart-container {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
        }
        .chart-container h3 { text-align: center; margin-top: 0; }
        @media (max-width: 768px) {
            .dashboard-grid { grid-template-columns: 1fr; }
        }

        /* --- Print Styles --- */
        @media print {
            body {
                padding: 0; margin: 0; font-size: 10pt; background-color: #fff;
            }
            header, .category-header-controls, .col-actions, .add-item-controls, .modal, .btn-delete-item, .sort-indicator, .add-category-controls {
                display: none !important;
            }
            #main-container {
                box-shadow: none; border: none; width: 100%; max-width: 100%;
            }
            .category-header { background-color: #fff; }
            .accordion { font-size: 1.4em; font-weight: bold; padding: 20px 0 10px 0; }
            .accordion:after { display: none; }
            .panel { display: block !important; padding: 0; border-bottom: none; }
            
            .stock-table { width: 100%; page-break-inside: auto; }
            .stock-table tr { page-break-inside: avoid; }
            .stock-table th, .stock-table td {
                padding: 6px 8px; border-bottom: 1px solid #ccc;
            }
            .stock-table th { background-color: #eee !important; }
            .col-stock, .col-min-stock { text-align: left; width: 15%; }
            .col-item { width: 70%; }
            .stock-level { padding: 0; font-size: 1em; }
            .low-stock {
                color: #000 !important; background-color: #eee !important;
                font-weight: bold; padding: 2px 4px;
            }
        }
    </style>
</head>
<body>

    <div id="main-container">
        <header>
            <h1>Central Administrative Tribunal, Chennai Bench</h1>
            <p>Stock Management System (v5)</p>
            <div class="header-controls">
                <input type="search" id="search-bar" placeholder="Type to search all items...">
                <div class="header-buttons">
                    <button id="dashboard-btn">üìà Dashboard</button>
                    <button id="batch-update-btn">‚ö° Quick Update</button>
                    <button id="report-btn">üìä Low Stock</button>
                    <button id="log-btn">üìú Activity Log</button>
                    <button id="print-btn">üñ®Ô∏è Print</button>
                </div>
            </div>
            <div class="data-buttons">
                <button id="export-btn">üíæ Export Data</button>
                <button id="import-btn">üìÇ Import Data</button>
                <input type="file" id="import-file-input" accept=".json">
            </div>
        </header>

        <div id="category-container">
            </div>

        <div class="add-category-controls">
            <div class="add-category-form">
                <input type="text" id="new-category-name" class="new-category-name" placeholder="Add new category...">
                <button id="btn-save-new-category" class="btn-save-new-category">Add Category</button>
            </div>
        </div>

    </div> <div id="report-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìä Low Stock Report</h2>
                <span class="close-btn">&times;</span>
            </div>
            <ul id="low-stock-list" class="modal-list"></ul>
        </div>
    </div>
    
    <div id="log-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìú Activity Log (Last 100)</h2>
                <span class="close-btn">&times;</span>
            </div>
            <ul id="activity-log-list" class="modal-list"></ul>
        </div>
    </div>
    
    <div id="item-edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="item-edit-title">Edit Item</h2>
                <span class="close-btn">&times;</span>
            </div>
            <div class="form-grid">
                <label for="edit-item-name">Item Name:</label>
                <input type="text" id="edit-item-name">
                
                <label for="edit-item-min-stock">Min. Stock:</label>
                <input type="number" id="edit-item-min-stock" min="0">
                
                <label for="edit-item-category">Category:</label>
                <select id="edit-item-category">
                    </select>
            </div>
            <div class="modal-footer">
                <button id="btn-save-item-changes" class="btn btn-save-changes">Save Changes</button>
            </div>
        </div>
    </div>
    
    <div id="batch-update-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ö° Quick Update (Stock-Take)</h2>
                <span class="close-btn">&times;</span>
            </div>
            <div id="batch-update-list-container">
                <div id="batch-update-list">
                    </div>
            </div>
            <div class="modal-footer">
                <button id="btn-save-batch-update" class="btn btn-save-changes">Save All Changes</button>
            </div>
        </div>
    </div>
    
    <div id="dashboard-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìà Dashboard</h2>
                <span class="close-btn">&times;</span>
            </div>
            <div class="dashboard-grid">
                <div class="chart-container">
                    <h3>Top 10 Low Stock Items</h3>
                    <canvas id="low-stock-chart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Items per Category</h3>
                    <canvas id="category-pie-chart"></canvas>
                </div>
            </div>
        </div>
    </div>


    <script>
        // --- 1. CONFIG & INITIAL DATA ---
        
        const DEFAULT_LOW_STOCK_THRESHOLD = 5;
        const LOG_LIMIT = 100; // Store last 100 transactions
        
        // LocalStorage Keys
        const STOCK_ITEMS_KEY = 'catStockItems_v4'; // Keeping v4 for data compatibility
        const STOCK_LEVELS_KEY = 'catStockLevels_v4';
        const STOCK_LOG_KEY = 'catStockLog_v4';
        const ITEM_SETTINGS_KEY = 'catItemSettings_v4';

        // Default list, used ONLY if localStorage is empty
        const initialData = {
            items: { // This is now the category list
                stationery: [
                    "A4 Tnpl Paper (80 Gsm)", "A4 Paper (70 Gsm)", "Greens Sheet Legal Size (70 Gsm))",
                    "White Sheet Legal Size(75 Gsm)", "Pencil", "Ball Pen (Black)", "Ball Pen (Blue)",
                    "Ball Pen (Red)", "Brown Tape", "Calculator", "Eraser", "Gell Pen (Black)",
                    "Gell Pen (Blue)", "Gell Pen (Red)", "Glue Stick", "Green Sheet Legal Size",
                    "Jauser Pen Blue (Pkt Of 10 Nos)", "Nataraj Pencil", "Pen Stand (Brown, Black)",
                    "Pen Stand (Plastic)", "Pen Stand (Wooden)", "Sharpner", "Stamp Pad Ink Small (15nos)",
                    "Stapler (Big Size)", "Stapler (Small Size)", "Stapler Pin (Big Size)",
                    "Stapler Pin (Small)", "Uni Ball Pen (Black)", "Uni Ball Pen (Blue)",
                    "Uni Ball Pen (Green)", "Uni Ball Pen (Red)", "White Sheet Legal Size", "Whitener",
                    "Writing Pad Acrylic"
                ],
                cleaning: [
                    "Big Towel (White)", "Bombay Broom (0%) Soft", "Broom", "Broom Soft",
                    "Brush For Mat Cleaning", "Bucket (Medium Size For Car)", "Bucket Big",
                    "Cleaning Cloth (Micro)", "Cleaning Concentrated Gel", "Cleaning Stick",
                    "Dettol Hand Wash (200ml)", "Dust Bin Cover Sample", "Dust Bin Cover Thick Big Size",
                    "Dustbin Cover (Big Size)", "Duster Clothes", "Floor Cleaner 500ml", "Good Knight Liquid",
                    "Hand Towel", "Hand Wash 500 Ml", "Hand Wash 5ltr Can", "Harpic", "Lysole",
                    "Odonil For Rest Room", "Phenyl", "Room Spray", "Tissue Hand Premier", "Tissue Roll",
                    "Toilet Cleaner 500ml", "Toilet Cleaning Brush", "Toilet Roll Stand",
                    "Turkey Towel (Plain Colour)", "Turkey Towel (White Colour)", "Wash Basin Cleaning Brush"
                ],
                kitchen: [
                    "Bone China Plates", "Borosil Glass", "Cup & Saucer", "Fork Spoon", "Glass Cap",
                    "Glass Tumbler (Box Of 6 Nos)", "Kettle - Prestige (1.5 Litrs)", "Meals Plate",
                    "Plastic Tray (Big Size)", "Spoon", "Steel Water Bottle", "Water Jug"
                ],
                furniture: [
                    "Battery (Aa)", "Battery (Aaa)", "Cushion Chair With Lumbar Support", "Hanger",
                    "Keyboard", "Mirror Big Size", "Pedestal Fan Crompton Metal", "Power Strip With Switch",
                    "Refrigerator 45 L", "Stool Double Step", "Wall Clock", "Wall Mounted Fan & Pedestal Fan"
                ],
                carCare: [
                    "Car Duster (Long Handle)", "Car Freshener", "Car Wash Shampoo (3m)",
                    "Dashboard Polish (Liquid)", "Godrej Car Spary (Spray)",
                    "Multi Purpose Cleaning Liquid (Foam Cleaner)", "Shampoo (For Car)", "Tyre Foam",
                    "Tyre Polish (Liquid)"
                ],
                misc: [
                    "Flower Wash Set", "Umberella (Umbrella)"
                ]
            },
            levels: {}, // Start empty
            settings: {}, // Start empty
            log: [] // Start empty
        };

        // --- 2. GLOBAL STATE VARIABLES ---
        let catStockItems = {};
        let catStockLevels = {};
        let catStockLog = [];
        let catItemSettings = {};
        
        // Chart.js instances (to destroy before recreating)
        let lowStockChartInstance = null;
        let categoryPieChartInstance = null;
        
        // --- 3. DATA HELPER FUNCTIONS (LocalStorage) ---

        function loadData() {
            // Load categories & items
            const storedItems = localStorage.getItem(STOCK_ITEMS_KEY);
            catStockItems = storedItems ? JSON.parse(storedItems) : initialData.items;
            
            // Load levels
            const storedLevels = localStorage.getItem(STOCK_LEVELS_KEY);
            catStockLevels = storedLevels ? JSON.parse(storedLevels) : initialData.levels;

            // Load settings
            const storedSettings = localStorage.getItem(ITEM_SETTINGS_KEY);
            catItemSettings = storedSettings ? JSON.parse(storedSettings) : initialData.settings;
            
            // Load log
            const storedLog = localStorage.getItem(STOCK_LOG_KEY);
            catStockLog = storedLog ? JSON.parse(storedLog) : initialData.log;
            
            // Sync data (if localStorage was empty)
            if (!storedItems) {
                // This is a first-time load. Populate levels and settings.
                let newLevels = {};
                let newSettings = {};
                Object.values(catStockItems).flat().forEach(item => {
                    newLevels[item] = 0; // Init stock at 0
                    newSettings[item] = { minStock: DEFAULT_LOW_STOCK_THRESHOLD }; // Init min stock
                });
                catStockLevels = newLevels;
                catItemSettings = newSettings;
                saveAllData();
            }
        }

        function saveItems() { localStorage.setItem(STOCK_ITEMS_KEY, JSON.stringify(catStockItems)); }
        function saveStock() { localStorage.setItem(STOCK_LEVELS_KEY, JSON.stringify(catStockLevels)); }
        function saveSettings() { localStorage.setItem(ITEM_SETTINGS_KEY, JSON.stringify(catItemSettings)); }
        function saveLog() { localStorage.setItem(STOCK_LOG_KEY, JSON.stringify(catStockLog)); }
        
        function saveAllData() {
            saveItems();
            saveStock();
            saveSettings();
            saveLog();
        }
        
        function logActivity(message, type = 'info') {
            const timestamp = new Date().toLocaleString('en-IN', { dateStyle: 'short', timeStyle: 'short' });
            catStockLog.unshift({ timestamp, message, type });
            catStockLog.splice(LOG_LIMIT); // Keep only the last LOG_LIMIT entries
            saveLog();
        }
        
        // Helper to get all items as a flat array
        function getAllItems() {
            return Object.values(catStockItems)
                .map(arr => arr.filter(item => typeof item === 'string')) // Filter out __categoryName
                .flat()
                .sort();
        }
        
        // Helper to get an item's min stock
        function getItemMinStock(item) {
            return catItemSettings[item]?.minStock ?? DEFAULT_LOW_STOCK_THRESHOLD;
        }
        
        // Helper to get all true item arrays (without metadata)
        function getCategoryItems(categoryKey) {
            return catStockItems[categoryKey].filter(item => typeof item === 'string');
        }
        
        // Helper to get category display name
        function getCategoryName(categoryKey) {
            return catStockItems[categoryKey].__categoryName || categoryKey;
        }

        // --- 4. RENDER FUNCTIONS ---

        /**
         * Wipes and repopulates all categories and tables from global state
         */
        function renderAllCategories() {
            const container = document.getElementById('category-container');
            container.innerHTML = ''; // Clear everything
            
            const categoryKeys = Object.keys(catStockItems).sort();
            
            for (const categoryKey of categoryKeys) {
                const categoryName = getCategoryName(categoryKey);
                
                // 1. Create Category Header
                const headerDiv = document.createElement('div');
                headerDiv.className = 'category-header';
                headerDiv.innerHTML = `
                    <button class="accordion" data-category-key="${categoryKey}">${categoryName}</button>
                    <div class="category-header-controls">
                        <button class="btn-rename-category" title="Rename Category" data-category-key="${categoryKey}">‚úèÔ∏è</button>
                        <button class="btn-delete-category" title="Delete Category" data-category-key="${categoryKey}">‚ùå</button>
                    </div>
                `;
                
                // 2. Create Panel
                const panel = document.createElement('div');
                panel.className = 'panel';
                panel.dataset.categoryKey = categoryKey;
                
                // 3. Create Table
                const table = document.createElement('table');
                table.className = 'stock-table';
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th class="col-item sortable-header" data-sort-by="item">Item Name <span class="sort-indicator"></span></th>
                            <th class="col-stock sortable-header" data-sort-by="stock">Current Stock <span class="sort-indicator"></span></th>
                            <th class="col-min-stock sortable-header" data-sort-by="minStock">Min Stock <span class="sort-indicator"></span></th>
                            <th class="col-actions">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                `;
                
                // 4. Create "Add Item" controls
                const addControls = document.createElement('div');
                addControls.className = 'add-item-controls';
                addControls.innerHTML = `
                    <button class="btn-show-add-form">‚ûï Add New Item to this Category</button>
                    <div class="add-item-form">
                        <input type="text" class="new-item-name" placeholder="New item name...">
                        <button class="btn btn-save-new">Save</button>
                    </div>
                `;
                
                // 5. Populate table body
                const tbody = table.querySelector('tbody');
                const items = getCategoryItems(categoryKey).sort();
                items.forEach(item => {
                    tbody.appendChild(createRowElement(item, categoryKey));
                });
                
                // 6. Assemble
                panel.appendChild(table);
                panel.appendChild(addControls);
                container.appendChild(headerDiv);
                container.appendChild(panel);
            }
            
            // Re-attach accordion listeners
            attachAccordionListeners();
            // Re-attach sorter listeners
            attachSortListeners();
        }
        
        /**
         * Creates a single <tr> element for an item
         */
        function createRowElement(item, categoryKey) {
            const stock = catStockLevels[item] || 0;
            const minStock = getItemMinStock(item);
            const lowStockClass = stock <= minStock ? 'low-stock' : '';

            const row = document.createElement('tr');
            row.dataset.itemName = item;
            row.dataset.categoryKey = categoryKey;
            
            row.innerHTML = `
                <td class="col-item">
                    ${item}
                    <button class="btn-item-edit" title="Edit ${item}">‚úèÔ∏è</button>
                    <button class="btn-delete-item" title="Delete ${item}">&times;</button>
                </td>
                <td class="col-stock">
                    <span class="stock-level ${lowStockClass}">${stock}</span>
                </td>
                <td class="col-min-stock">
                    <span>${minStock}</span>
                </td>
                <td class="col-actions">
                    <input type="number" class="quantity-input" value="1" min="0">
                    <button class="btn btn-stock-in">Stock In</button>
                    <button class="btn btn-stock-out">Stock Out</button>
                    <button class="btn btn-reset">Reset</button>
                </td>
            `;
            return row;
        }
        
        /**
         * Updates just the stock-related cells in the DOM
         */
        function updateStockInDOM(itemName) {
            const row = document.querySelector(`tr[data-item-name="${itemName}"]`);
            if (!row) return;
            
            const stock = catStockLevels[itemName] || 0;
            const minStock = getItemMinStock(itemName);
            const lowStockClass = stock <= minStock ? 'low-stock' : '';
            
            row.querySelector('.stock-level').textContent = stock;
            row.querySelector('.stock-level').className = `stock-level ${lowStockClass}`;
            row.querySelector('.col-min-stock span').textContent = minStock;
        }

        // --- 5. EVENT LISTENER ATTACHMENT ---
        
        function attachAccordionListeners() {
            document.querySelectorAll(".accordion").forEach(acc => {
                acc.addEventListener("click", function () {
                    this.classList.toggle("active");
                    const panel = this.parentElement.nextElementSibling;
                    panel.style.display = panel.style.display === "block" ? "none" : "block";
                });
            });
        }
        
        function attachSortListeners() {
            document.querySelectorAll('.sortable-header').forEach(header => {
                header.addEventListener('click', () => {
                    const table = header.closest('table');
                    const tbody = table.querySelector('tbody');
                    const rows = Array.from(tbody.querySelectorAll('tr'));
                    const sortBy = header.dataset.sortBy;
                    const currentOrder = header.dataset.sortOrder || 'desc';
                    const newOrder = currentOrder === 'asc' ? 'desc' : 'asc';

                    table.querySelectorAll('.sortable-header').forEach(h => {
                        h.dataset.sortOrder = '';
                        h.querySelector('.sort-indicator').textContent = '';
                    });
                    
                    header.dataset.sortOrder = newOrder;
                    header.querySelector('.sort-indicator').textContent = newOrder === 'asc' ? '‚ñ≤' : '‚ñº';

                    rows.sort((a, b) => {
                        let valA, valB;
                        if (sortBy === 'item') {
                            valA = a.dataset.itemName.toLowerCase();
                            valB = b.dataset.itemName.toLowerCase();
                        } else { // 'stock' or 'minStock'
                            const selector = (sortBy === 'stock') ? '.stock-level' : '.col-min-stock span';
                            valA = parseInt(a.querySelector(selector).textContent, 10);
                            valB = parseInt(b.querySelector(selector).textContent, 10);
                        }
                        
                        if (valA < valB) return newOrder === 'asc' ? -1 : 1;
                        if (valA > valB) return newOrder === 'asc' ? 1 : -1;
                        return 0;
                    });
                    
                    rows.forEach(row => tbody.appendChild(row));
                });
            });
        }

        // --- 6. MAIN EXECUTION (on page load) ---

        document.addEventListener("DOMContentLoaded", () => {
            loadData();
            renderAllCategories();

            // --- 7. GLOBAL EVENT LISTENERS ---

            // --- 7a. Main Container Event Delegation (Stock, Add, Delete, Edit) ---
            const mainContainer = document.getElementById("main-container");
            mainContainer.addEventListener("click", function (e) {
                const row = e.target.closest('tr');
                const panel = e.target.closest('.panel');
                const controls = e.target.closest('.add-item-controls');
                const header = e.target.closest('.category-header');

                // --- Stock In/Out/Reset Logic ---
                if (e.target.classList.contains("btn-stock-in") || e.target.classList.contains("btn-stock-out") || e.target.classList.contains("btn-reset")) {
                    if (!row) return;
                    const itemName = row.dataset.itemName;
                    let currentStock = catStockLevels[itemName] || 0;
                    const qty = parseInt(row.querySelector(".quantity-input").value, 10);

                    if (isNaN(qty) || qty < 0) {
                        alert("Please enter a valid, non-negative quantity.");
                        return;
                    }
                    
                    let newStock = currentStock;
                    if (e.target.classList.contains("btn-stock-in")) {
                        newStock = currentStock + qty;
                        logActivity(`'${itemName}' - Stocked In ${qty}. Stock: ${currentStock} ‚ûî ${newStock}`, 'add');
                    } else if (e.target.classList.contains("btn-stock-out")) {
                        newStock = Math.max(0, currentStock - qty);
                        logActivity(`'${itemName}' - Stocked Out ${qty}. Stock: ${currentStock} ‚ûî ${newStock}`, 'remove');
                    } else if (e.target.classList.contains("btn-reset")) {
                        newStock = qty;
                        logActivity(`'${itemName}' - Stock RESET to ${newStock}. (Was ${currentStock})`, 'set');
                    }

                    catStockLevels[itemName] = newStock;
                    saveStock();
                    updateStockInDOM(itemName);
                    row.querySelector(".quantity-input").value = "1";
                }

                // --- Show "Add New Item" Form ---
                if (e.target.classList.contains("btn-show-add-form")) {
                    e.target.style.display = 'none';
                    controls.querySelector('.add-item-form').style.display = 'flex';
                    controls.querySelector('.new-item-name').focus();
                }

                // --- Save New Item Logic ---
                if (e.target.classList.contains("btn-save-new")) {
                    if (!panel || !controls) return;
                    
                    const categoryKey = panel.dataset.categoryKey;
                    const input = controls.querySelector(".new-item-name");
                    const newItemName = input.value.trim();

                    if (!newItemName) { alert("Please enter an item name."); return; }
                    if (catStockLevels[newItemName] !== undefined) {
                        alert("This item name already exists. Please choose a unique name."); return;
                    }
                    
                    catStockItems[categoryKey].push(newItemName);
                    catStockLevels[newItemName] = 0;
                    catItemSettings[newItemName] = { minStock: DEFAULT_LOW_STOCK_THRESHOLD };
                    logActivity(`New item '${newItemName}' added to ${getCategoryName(categoryKey)}`, 'new');
                    
                    saveItems();
                    saveStock();
                    saveSettings();
                    
                    const newRow = createRowElement(newItemName, categoryKey);
                    panel.querySelector('tbody').appendChild(newRow);
                    
                    input.value = '';
                    controls.querySelector('.add-item-form').style.display = 'none';
                    controls.querySelector('.btn-show-add-form').style.display = 'block';
                }
                
                // --- Delete Item Logic ---
                if (e.target.classList.contains("btn-delete-item")) {
                    if (!row) return;
                    const itemName = row.dataset.itemName;
                    const categoryKey = row.dataset.categoryKey;

                    if (!confirm(`Are you sure you want to permanently delete "${itemName}"? This cannot be undone.`)) return;
                    
                    delete catStockLevels[itemName];
                    delete catItemSettings[itemName];
                    catStockItems[categoryKey] = catStockItems[categoryKey].filter(item => item !== itemName);
                    logActivity(`Item '${itemName}' DELETED from ${getCategoryName(categoryKey)}`, 'delete');
                    
                    saveItems();
                    saveStock();
                    saveSettings();
                    row.remove();
                }
                
                // --- Edit Item Logic (Opens Modal) ---
                if (e.target.classList.contains("btn-item-edit")) {
                    if (!row) return;
                    const itemName = row.dataset.itemName;
                    const categoryKey = row.dataset.categoryKey;
                    openItemEditModal(itemName, categoryKey);
                }
                
                // --- Rename Category Logic ---
                if (e.target.classList.contains("btn-rename-category")) {
                    if (!header) return;
                    const categoryKey = e.target.dataset.categoryKey;
                    const currentName = getCategoryName(categoryKey);
                    const newName = prompt(`Enter new name for category "${currentName}":`, currentName);
                    
                    if (newName && newName.trim() !== currentName) {
                        catStockItems[categoryKey].__categoryName = newName.trim();
                        logActivity(`Category '${currentName}' renamed to '${newName.trim()}'`, 'edit');
                        saveItems();
                        renderAllCategories();
                    }
                }
                
                // --- Delete Category Logic ---
                if (e.target.classList.contains("btn-delete-category")) {
                    if (!header) return;
                    const categoryKey = e.target.dataset.categoryKey;
                    const categoryName = getCategoryName(categoryKey);
                    const items = getCategoryItems(categoryKey);
                    
                    let confirmMsg = `Are you sure you want to delete the category "${categoryName}"?`;
                    if (items.length > 0) {
                        confirmMsg += `\n\nWARNING: This will also delete all ${items.length} items in it (like ${items[0]})!`;
                    }
                    
                    if (confirm(confirmMsg)) {
                        items.forEach(item => {
                            delete catStockLevels[item];
                            delete catItemSettings[item];
                        });
                        delete catStockItems[categoryKey];
                        logActivity(`Category '${categoryName}' DELETED`, 'delete');
                        saveAllData();
                        renderAllCategories();
                    }
                }
            });
            
            // --- 7b. Add New Category (Bottom Form) ---
            document.getElementById('btn-save-new-category').addEventListener('click', () => {
                const input = document.getElementById('new-category-name');
                const newName = input.value.trim();
                const newKey = newName.toLowerCase().replace(/[^a-z0-9]/g, '');
                
                if (!newName) { alert("Please enter a category name."); return; }
                if (!newKey) { alert("Please enter a valid name."); return; }
                if (catStockItems[newKey]) { alert("This category key already exists."); return; }
                
                catStockItems[newKey] = [];
                catStockItems[newKey].__categoryName = newName;
                logActivity(`New category '${newName}' added`, 'new');
                
                saveItems();
                renderAllCategories();
                input.value = '';
            });

            // --- 7c. Search Bar Logic ---
            const searchBar = document.getElementById("search-bar");
            searchBar.addEventListener("input", (e) => {
                const searchValue = e.target.value.toLowerCase();
                if (searchValue.length > 0) {
                    document.querySelectorAll(".accordion").forEach(acc => {
                        acc.classList.add('active');
                        acc.parentElement.nextElementSibling.style.display = 'block';
                    });
                }
                document.querySelectorAll(".stock-table tbody tr").forEach(row => {
                    const itemName = row.dataset.itemName.toLowerCase();
                    row.style.display = itemName.includes(searchValue) ? "" : "none";
                });
            });

            // --- 7d. Modal Logic (Generic Setup) ---
            function setupModal(triggerBtnId, modalId, contentListId = null, populateFn = null, onOpenFn = null) {
                const modal = document.getElementById(modalId);
                const btn = document.getElementById(triggerBtnId);
                const closeBtn = modal.querySelector(".close-btn");
                
                btn.onclick = () => {
                    if (populateFn) populateFn(document.getElementById(contentListId));
                    if (onOpenFn) onOpenFn();
                    modal.style.display = "block";
                }
                closeBtn.onclick = () => modal.style.display = "none";
                window.addEventListener('click', (e) => {
                    if (e.target == modal) modal.style.display = "none";
                });
            }
            
            // --- Low Stock Report
            function populateLowStock(listEl) {
                listEl.innerHTML = '';
                let itemsFound = 0;
                for (const categoryKey in catStockItems) {
                    const categoryName = getCategoryName(categoryKey);
                    let categoryHTML = `<li class="category-title">${categoryName}</li>`;
                    let categoryHasLowStock = false;
                    
                    getCategoryItems(categoryKey).sort().forEach(item => {
                        const stock = catStockLevels[item] || 0;
                        const minStock = getItemMinStock(item);
                        if (stock <= minStock) {
                            categoryHTML += `<li><strong>${item}:</strong> ${stock} (Min: ${minStock})</li>`;
                            itemsFound++;
                            categoryHasLowStock = true;
                        }
                    });
                    if (categoryHasLowStock) listEl.innerHTML += categoryHTML;
                }
                if (itemsFound === 0) listEl.innerHTML = '<li>All items are well-stocked.</li>';
            }
            setupModal('report-btn', 'report-modal', 'low-stock-list', populateLowStock);
            
            // --- Activity Log
            function populateActivityLog(listEl) {
                if (catStockLog.length === 0) {
                    listEl.innerHTML = '<li>No activity recorded yet.</li>'; return;
                }
                listEl.innerHTML = catStockLog.map(entry =>
                    `<li class="log-${entry.type}"><strong>[${entry.timestamp}]</strong> ${entry.message}</li>`
                ).join('');
            }
            setupModal('log-btn', 'log-modal', 'activity-log-list', populateActivityLog);
            
            // --- Dashboard
            setupModal('dashboard-btn', 'dashboard-modal', null, null, populateDashboard);
            
            // --- Batch Update
            setupModal('batch-update-btn', 'batch-update-modal', null, null, populateBatchUpdate);

            // --- 7e. Print Button ---
            document.getElementById("print-btn").addEventListener("click", () => window.print());
            
            // --- 7f. Data Export ---
            document.getElementById("export-btn").addEventListener("click", () => {
                const dataToExport = {
                    items: catStockItems,
                    levels: catStockLevels,
                    settings: catItemSettings,
                    log: catStockLog
                };
                const dataStr = JSON.stringify(dataToExport, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `cat_stock_backup_v5_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            });
            
            // --- 7g. Data Import ---
            const importBtn = document.getElementById("import-btn");
            const importFileInput = document.getElementById("import-file-input");
            importBtn.addEventListener("click", () => importFileInput.click());
            importFileInput.addEventListener("change", (e) => {
                if (!e.target.files.length) return;
                if (!confirm("This will OVERWRITE all current data. Are you sure?")) {
                    e.target.value = null; return;
                }
                
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        if (importedData.items && importedData.levels && importedData.settings) {
                            catStockItems = importedData.items;
                            catStockLevels = importedData.levels;
                            catItemSettings = importedData.settings;
                            catStockLog = importedData.log || [];
                            
                            saveAllData();
                            alert("Data imported successfully. The page will now reload.");
                            location.reload();
                        } else {
                            alert("Import failed: File format is incorrect or missing data.");
                        }
                    } catch (err) { alert(`An error occurred: ${err.message}`); }
                    finally { e.target.value = null; }
                };
                reader.readAsText(file);
            });
            
            // --- 8. ADVANCED FEATURE LOGIC ---
            
            // --- Item Edit Modal ---
            const itemEditModal = document.getElementById('item-edit-modal');
            const editModalTitle = document.getElementById('item-edit-title');
            const editItemName = document.getElementById('edit-item-name');
            const editMinStock = document.getElementById('edit-item-min-stock');
            const editCategory = document.getElementById('edit-item-category');
            const saveItemBtn = document.getElementById('btn-save-item-changes');
            let currentEditItem = { name: null, category: null };
            
            function openItemEditModal(itemName, categoryKey) {
                currentEditItem.name = itemName;
                currentEditItem.category = categoryKey;
                
                editModalTitle.textContent = `Edit "${itemName}"`;
                editItemName.value = itemName;
                editMinStock.value = getItemMinStock(itemName);
                
                editCategory.innerHTML = '';
                Object.keys(catStockItems).sort().forEach(key => {
                    const categoryName = getCategoryName(key);
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = categoryName;
                    option.selected = (key === categoryKey);
                    editCategory.appendChild(option);
                });
                
                itemEditModal.style.display = 'block';
            }
            
            saveItemBtn.onclick = () => {
                const oldName = currentEditItem.name;
                const oldCategory = currentEditItem.category;
                const newName = editItemName.value.trim();
                const newMinStock = parseInt(editMinStock.value, 10);
                const newCategory = editCategory.value;
                
                if (!newName) { alert("Item name cannot be empty."); return; }
                if (isNaN(newMinStock) || newMinStock < 0) { alert("Min stock must be 0 or more."); return; }
                
                // Check if name changed and new name already exists
                if (newName !== oldName && catStockLevels[newName] !== undefined) {
                    alert("The new item name already exists. Please choose a unique name.");
                    return;
                }
                
                // 1. Update Name (if changed)
                if (newName !== oldName) {
                    // Update main data objects
                    catStockLevels[newName] = catStockLevels[oldName];
                    delete catStockLevels[oldName];
                    
                    catItemSettings[newName] = catItemSettings[oldName] || {};
                    delete catItemSettings[oldName];
                    
                    // Update item in its category array
                    const index = catStockItems[oldCategory].indexOf(oldName);
                    if (index > -1) catStockItems[oldCategory][index] = newName;
                    
                    logActivity(`Item '${oldName}' renamed to '${newName}'`, 'edit');
                }
                
                // 2. Update Min Stock
                catItemSettings[newName].minStock = newMinStock;
                logActivity(`Item '${newName}' min stock set to ${newMinStock}`, 'edit');
                
                // 3. Update Category (if changed)
                if (newCategory !== oldCategory) {
                    // Remove from old category
                    catStockItems[oldCategory] = catStockItems[oldCategory].filter(item => item !== newName);
                    // Add to new category
                    catStockItems[newCategory].push(newName);
                    logActivity(`Item '${newName}' moved from ${getCategoryName(oldCategory)} to ${getCategoryName(newCategory)}`, 'edit');
                }
                
                saveAllData();
                renderAllCategories(); // Full re-render to reflect all changes
                itemEditModal.style.display = 'none';
            };
            
            // --- Batch Update Modal ---
            function populateBatchUpdate() {
                const listEl = document.getElementById('batch-update-list');
                listEl.innerHTML = '';
                getAllItems().forEach(item => {
                    const stock = catStockLevels[item] || 0;
                    listEl.innerHTML += `
                        <label for="batch-${item}">${item}</label>
                        <input type="number" id="batch-${item}" data-item-name="${item}" value="${stock}" min="0">
                    `;
                });
            }
            
            document.getElementById('btn-save-batch-update').onclick = () => {
                if (!confirm("This will overwrite all changed stock levels. Are you sure?")) return;
                
                let changes = 0;
                document.querySelectorAll('#batch-update-list input').forEach(input => {
                    const itemName = input.dataset.itemName;
                    const newStock = parseInt(input.value, 10);
                    const oldStock = catStockLevels[itemName] || 0;
                    
                    if (!isNaN(newStock) && newStock >= 0 && newStock !== oldStock) {
                        catStockLevels[itemName] = newStock;
                        logActivity(`'${itemName}' - Stock RESET to ${newStock} (was ${oldStock}) via Batch Update`, 'set');
                        changes++;
                    }
                });
                
                saveStock();
                renderAllCategories();
                alert(`${changes} item(s) updated successfully.`);
                document.getElementById('batch-update-modal').style.display = 'none';
            };
            
            // --- Dashboard Modal ---
            function populateDashboard() {
                // 1. Low Stock Chart
                const allItems = getAllItems();
                const lowStockItems = allItems.map(item => ({
                    name: item,
                    stock: catStockLevels[item] || 0,
                    minStock: getItemMinStock(item)
                }))
                .filter(item => item.stock <= item.minStock)
                .sort((a, b) => (a.stock / a.minStock) - (b.stock / b.minStock)) // Sort by % of min stock
                .slice(0, 10); // Get top 10
                
                const lowStockCtx = document.getElementById('low-stock-chart').getContext('2d');
                if (lowStockChartInstance) lowStockChartInstance.destroy();
                lowStockChartInstance = new Chart(lowStockCtx, {
                    type: 'bar',
                    data: {
                        labels: lowStockItems.map(item => item.name),
                        datasets: [
                            {
                                label: 'Current Stock',
                                data: lowStockItems.map(item => item.stock),
                                backgroundColor: 'rgba(220, 53, 69, 0.6)'
                            },
                            {
                                label: 'Minimum Stock',
                                data: lowStockItems.map(item => item.minStock),
                                backgroundColor: 'rgba(255, 193, 7, 0.6)'
                            }
                        ]
                    },
                    options: { responsive: true }
                });
                
                // 2. Category Pie Chart
                const categoryLabels = Object.keys(catStockItems).map(key => getCategoryName(key));
                const categoryData = Object.keys(catStockItems).map(key => getCategoryItems(key).length);
                
                const pieCtx = document.getElementById('category-pie-chart').getContext('2d');
                if (categoryPieChartInstance) categoryPieChartInstance.destroy();
                categoryPieChartInstance = new Chart(pieCtx, {
                    type: 'pie',
                    data: {
                        labels: categoryLabels,
                        datasets: [{
                            data: categoryData,
                            backgroundColor: [
                                'rgba(0, 123, 255, 0.7)', 'rgba(40, 167, 69, 0.7)', 'rgba(255, 193, 7, 0.7)',
                                'rgba(23, 162, 184, 0.7)', 'rgba(108, 117, 125, 0.7)', 'rgba(102, 16, 242, 0.7)'
                            ]
                        }]
                    },
                    options: { responsive: true }
                });
            }

        }); // End DOMContentLoaded
    </script>

</body>
</html>